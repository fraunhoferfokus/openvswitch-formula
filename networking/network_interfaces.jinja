###
### ! SaltStack managed file !
### Your changes may be reverted at any given point in time.
### Contact your sysadmin for permanent changes.
###
#
## ! OpenVSwitch-adapted network/interfaces ! 
#
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

{% for dev, settings in interfaces.items() -%}
  {% if settings.has_key('comment') -%}
# {{ settings['comment'] }}
  {%- endif %}
auto {{ dev }}
  {%- if dev.startswith('vlan') -%}
    {%- set vlan = dev[4:] -%}
    {%- set raw_dev = settings.raw_dev -%}
  {%- elif dev.split('.')|count == 2 and 
        dev.split('.')[1].isalnum() -%}
    {%- set raw_dev = dev.split('.')[0] -%}
    {%- set vlan = dev.split('.')[1] -%}
  {%- else -%}
    {%- set vlan = False -%}
  {%- endif -%}
  {%- if settings.has_key('v4addr') %}
iface {{ dev }} inet static
    {% if vlan -%}
    vlan-raw-device {{ raw_dev }}
    {% endif -%}
    address   {{ settings['v4addr'].split('/')[0] }}
    network   {{ settings['network'].split('/')[0] }}
    netmask   {{ settings['netmask'] }}
    {% if settings.has_key('default_gw') -%}
    gateway   {{ settings['default_gw'] }}
    {% endif -%}
    broadcast {{ settings['broadcast'] }}
  {%- endif %}
  {% if settings.has_key('v6addr') %}
iface {{ dev }} inet6 static
  {%- set addr, prefix = settings['v6addr'].split('/') %}
    address   {{ addr }}
    netmask   {{ prefix }}
    {%- if settings.has_key('privext') %}
    privext   {{ settings['privext'] }}
    {%- endif %}
    {%- if subnet.has_key('scope') %}
    scope     {{ settings['scope'] }}
    {%- else %} 
    # is scope necessary for inet6?
    {% endif %} 
  {% endif %}
  {%- if settings.has_key('uplink') %}
# uplink for {{ dev }}
auto {{ settings.uplink }}
iface {{ settings.uplink }} inet manual
    post-up ip link set promisc on {{ settings.uplink }}
    pre-down ip link set promisc off {{ settings.uplink }}
  {%- endif %}
{% endfor %}
